name: ğŸ“£ Publish

on:
  # Triggers the workflow on published releases
  release:
    types: [published]

jobs:
  check:
    name: ğŸ‘€ Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›‘ Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.11.0

      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3

      - name: â” Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 16.x
          registry-url: https://registry.npmjs.org/

      # check if the github release version is the same as the package.json version
      - name: ğŸ· Check release version
        run: |
          RELEASE_VERSION=$(echo $GITHUB_REF | cut -d '/' -f 3 | sed 's/v//')
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          if [ "$RELEASE_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "Error: Release version ($RELEASE_VERSION) and package version ($PACKAGE_VERSION) do not match!"
            exit 1
          fi

      - name: ğŸ“¦ Install dependencies
        run: yarn && yarn install

      - name: ğŸš¦ Lint
        run: yarn run lint

      - name: Ê¦ Typecheck
        run: yarn run typecheck

      - name: ğŸ§ª Test
        run: yarn run test

      - name: ğŸ³ Build
        run: yarn run build

  publish:
    name: ğŸ“¢ Publish
    needs: check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›‘ Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.11.0

      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3

      - name: â” Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 16.x
          registry-url: https://registry.npmjs.org/

      - name: ğŸ“¦ Install dependencies
        run: yarn && yarn install

      - name: ğŸ“¢ Publish
        run: yarn publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}


